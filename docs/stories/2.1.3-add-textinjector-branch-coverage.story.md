# Story 2.1.3: Add TextInjector Branch Coverage

## Status

Done

## Story

**As a** developer,
**I want** TextInjector to have comprehensive branch coverage tests,
**so that** I have confidence that all conditional logic paths work correctly across different injection modes and error scenarios.

## Acceptance Criteria

1. All 13 services have ≥80% code coverage
2. Happy path tests for all public methods
3. Error case tests (exceptions, null inputs, edge cases)
4. Integration tests for service interactions
5. Thread-safety tests for concurrent services

## Tasks / Subtasks

- [ ] Add branch coverage tests for `ShouldUseTyping()` method (AC: 2, 3)
  - [ ] Test SmartAuto mode with sensitive content detection
  - [ ] Test SmartAuto mode with secure field detection (IsInSecureField)
  - [ ] Test PreferPaste mode edge cases (secure field override)
- [ ] Add branch coverage tests for clipboard operations (AC: 2, 3)
  - [ ] Test InjectViaClipboard with retry logic (3 attempts)
  - [ ] Test clipboard restoration success path
  - [ ] Test clipboard restoration failure path
  - [ ] Test clipboard restoration when user modifies clipboard
  - [ ] Test CRC32 hash comparison for clipboard verification
- [ ] Add branch coverage tests for typing operations (AC: 2, 3)
  - [ ] Test InjectViaTyping with newline characters (\n)
  - [ ] Test InjectViaTyping with tab characters (\t)
  - [ ] Test InjectViaTyping with regular characters
  - [ ] Test TYPING_DELAY_MS handling
- [ ] Add branch coverage tests for error handling (AC: 3)
  - [ ] Test fallback from typing to clipboard on exception
  - [ ] Test clipboard timeout (3 second thread join)
  - [ ] Test SetClipboardText retry logic (5 attempts with backoff)
  - [ ] Test SimulateCtrlV exception handling
- [ ] Add branch coverage tests for Win32 API edge cases (AC: 3)
  - [ ] Test IsInSecureField when GetFocus returns IntPtr.Zero
  - [ ] Test IsInSecureField with password field detection
  - [ ] Test IsInSecureField with exception handling
- [ ] Verify branch coverage target reached (AC: 1)
  - [ ] Run coverage report: `dotnet test --collect:"XPlat Code Coverage"`
  - [ ] Verify branch coverage improved from 0% baseline

## Dev Notes

### Previous Story Insights

[Source: docs/stories/2.1.2-add-audiorecorder-test-coverage.story.md#Dev Agent Record]

From Story 2.1.2 completion notes:
- **Test Organization**: Group tests by category (5 categories: device selection, cleanup, disposal, memory, thread-safety)
- **Coverage Measurement Note**: Coverage tools may produce inconsistent metrics between runs - focus on qualitative test value
- **Test Isolation**: Run test classes in isolation for faster iteration (full suite times out >3 minutes)
- **Edge Case Focus**: Tests should target uncovered code paths, error handling, concurrent operations
- **Reflection for Private Methods**: Use reflection to test private methods (see AudioRecorderTests pattern)

### TextInjector Service Specification

[Source: docs/architecture.md#TextInjector]

**TextInjector** (`Services/TextInjector.cs`)
- **Tech**: H.InputSimulator 1.2.1
- **Modes**: SmartAuto, AlwaysType, AlwaysPaste, PreferType, PreferPaste
- **Smart Logic**: Clipboard for >50 chars, typing for short text
- **Clipboard Safety**: CRC32 verification, restore original
- **Thread Safety**: Dispatcher marshaling for UI thread
- **Performance**: Optimized delays (5ms clipboard, 1ms key events)
- **Retry Logic**: 3 attempts for clipboard read, 5 attempts for clipboard write

### Current Implementation Details

[Source: VoiceLite/VoiceLite/Services/TextInjector.cs]

**Key fields and constants**:
```csharp
private const int SHORT_TEXT_THRESHOLD = 50; // Use typing for text shorter than this
private const int LONG_TEXT_THRESHOLD = 100; // Text longer than this is considered "long"
private const int TYPING_DELAY_MS = 2; // Delay between keystrokes when typing
public bool AutoPaste { get; set; } = true;
```

**Injection mode logic** (lines 101-131):
- `AlwaysType`: Always returns true
- `AlwaysPaste`: Always returns false
- `PreferType`: Returns false if text ≥ 100 chars
- `PreferPaste`: Returns true if IsInSecureField() OR text < 10 chars
- `SmartAuto`: Returns true if IsInSecureField() OR text < 50 chars OR ContainsSensitiveContent(text)

**Sensitive content detection** (lines 133-148):
- Returns true if: text.Length < 30 AND no spaces AND has special chars
- Uses ContainsSpecialChars() helper (checks for non-alphanumeric chars)

**Secure field detection** (lines 150-190):
- Win32 API calls: GetFocus(), GetClassName(), SendMessage(), GetWindowLong()
- Checks for password field indicators in class name and window text
- Checks ES_PASSWORD style flag (0x0020)
- Returns false on exception (err on side of caution)

**Clipboard operations** (lines 235-384):
- **InjectViaClipboard**: Preserves original clipboard with 3-attempt retry
- **Clipboard restoration**: Async Task with 50ms delay, CRC32 verification
- **CRC32 hash comparison**: Handles cases where string equality fails
- **User modification detection**: Skips restoration if clipboard changed

**Typing operations** (lines 209-233):
- **Character handling**: Newline (\n) → VirtualKeyCode.RETURN, Tab (\t) → VirtualKeyCode.TAB
- **Typing delay**: Thread.Sleep(TYPING_DELAY_MS) between characters (2ms)

**Error handling** (lines 65-98):
- Try typing first, fallback to clipboard on exception
- Clipboard operations wrapped in try/finally for restoration
- Thread join timeout: 3 seconds for clipboard operations
- SetClipboardText retry: 5 attempts with 5ms * (attempt + 1) backoff

**Performance optimizations**:
- Clipboard restore delay: 50ms (reduced from 300ms)
- SetClipboardText retry delays: 5ms, 10ms, 15ms, 20ms, 25ms (total 75ms worst case)
- SimulateCtrlV timing: 1ms delays (total 2ms)

### Existing Test Coverage

[Source: VoiceLite/VoiceLite.Tests/Services/TextInjectorTests.cs]

**Current test file structure**:
- 18 existing [Fact]/[Theory] tests
- Uses xUnit, FluentAssertions
- Test class does NOT implement IDisposable (no cleanup needed)
- Reflection helpers for private method testing (lines 224-243)

**Current tests cover**:
1. Constructor validation (null settings)
2. AutoPaste property getter/setter
3. InjectText with null/whitespace (early return path)
4. ShouldUseTyping for each mode:
   - AlwaysType → true
   - AlwaysPaste → false
   - PreferType → true for <100 chars, false for ≥100 chars
   - PreferPaste → true for <10 chars, false for >10 chars
   - SmartAuto → true for <50 chars, false for ≥50 chars
5. ContainsSensitiveContent:
   - Short text (<30) with special chars + no spaces → true
   - Long text (>30) → false
   - Short text (<30) with spaces → false
6. ContainsSpecialChars:
   - Alphanumeric only → false
   - With special chars (@, !, #, $) → true

**Identified branch coverage gaps** (need tests for):
1. ~~ShouldUseTyping branches~~ - **Partially covered, missing:**
   - IsInSecureField() returning true (lines 123, 118)
   - ContainsSensitiveContent() returning true (line 127)
2. InjectViaClipboard branches:
   - Clipboard read retry logic (lines 241-267)
   - Clipboard restoration success/failure (lines 320-367)
   - CRC32 hash comparison (lines 315-318)
   - User clipboard modification detection (line 319, 369-375)
3. InjectViaTyping branches:
   - Newline character handling (line 214-216)
   - Tab character handling (line 218-220)
   - TYPING_DELAY_MS > 0 check (line 228)
4. Error handling branches:
   - Fallback to clipboard on typing exception (lines 86-92)
   - Thread join timeout (line 413)
   - SetClipboardText retry logic (lines 427-450)
   - SimulateCtrlV exception (lines 486-489)
5. Win32 API edge cases:
   - GetFocus() returns IntPtr.Zero (line 156)
   - IsInSecureField exception handling (lines 183-187)

### Testing Standards

[Source: CLAUDE.md#Testing]

**Test commands**:
```bash
# Run all tests
dotnet test VoiceLite/VoiceLite.Tests/VoiceLite.Tests.csproj

# Run specific test class
dotnet test VoiceLite/VoiceLite.Tests/VoiceLite.Tests.csproj --filter "FullyQualifiedName~TextInjectorTests"

# Run tests with coverage
dotnet test VoiceLite/VoiceLite.Tests/VoiceLite.Tests.csproj --collect:"XPlat Code Coverage" --settings VoiceLite.Tests/coverlet.runsettings
```

**Coverage targets**:
- Overall target: ≥75% coverage
- Services/ target: ≥80% coverage
- TextInjector current: 100% line, 0% branch (baseline from Story 2.1.1)
- TextInjector target: ≥80% branch coverage

**Test framework**:
- xUnit 2.9.2
- Moq 4.20.70 for mocking (if needed for Settings)
- FluentAssertions 6.12.0 for assertions

**Test patterns**:
- Use [Fact] attribute for tests
- Use [Theory] with [InlineData] for parameterized tests
- Follow naming: `MethodName_Scenario_ExpectedBehavior`
- Use reflection to test private methods (see existing helpers)

### Project Structure Notes

[Source: VoiceLite/VoiceLite.Tests/Services/TextInjectorTests.cs]

**Test file location**: `VoiceLite/VoiceLite.Tests/Services/TextInjectorTests.cs` (already exists)

**Service file location**: `VoiceLite/VoiceLite/Services/TextInjector.cs`

**No structural conflicts identified** - test file already exists in correct location following project conventions.

**Note on Win32 API testing**: IsInSecureField() uses Win32 APIs that may not work in test context. Consider mocking or testing error handling path only.

## Change Log

| Date       | Version | Description               | Author |
| ---------- | ------- | ------------------------- | ------ |
| 2025-10-10 | 1.0     | Story created (Draft)     | SM Agent (Bob) |
| 2025-10-10 | 1.1     | Story approved (100% validation pass rate) | SM Agent (Bob) |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent during implementation_

### Debug Log References

_To be populated by Dev Agent during implementation_

### Completion Notes List

_To be populated by Dev Agent during implementation_

### File List

_To be populated by Dev Agent during implementation_

## QA Results

_To be populated by QA Agent after implementation_
